<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Welcome to KBD</title>
        <link rel="stylesheet" type="text/css" href="/styles/addquestion.css" />
        <link
            href="https://fonts.googleapis.com/css?family=Montserrat|Poppins|Raleway&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                margin: 0;
                overflow-x: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
                background: linear-gradient(135deg, #1a1a40, #3a1c71);
                color: white;
                font-family: 'Montserrat', sans-serif;
            }

            .bottom-tag-line {
                text-align: center;
                font-size: 12px;
                margin-top: 2rem;
            }

            .scorecard-container {
                padding: 2rem;
                border-radius: 20px;
                box-shadow: 0 10px 40px rgba(255, 105, 180, 0.3);
                background: rgba(30, 30, 60, 0.95);
                width: 100%;
                max-width: 600px;
                /* text-align: center; */
                z-index: 2;
            }

            .score-item {
                display: flex;
                justify-content: space-between;
                padding: 7px 0;
                border-bottom: 1px solid rgba(255, 255, 255, 0.2);
                font-size: 1.1rem;
            }

            /* .score-item:last-child {
                border-bottom: none;
            } */

            #btn-home {
                margin-top: 1rem;
                padding: 10px 20px;
                font-size: 1rem;
                font-weight: 600;
                color: #fff;
                background: #4e54c8;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.3s ease;
            }

            #btn-home:hover {
                background: #6a11cb;
            }

            #btn-play-again {
                margin-top: 1rem;
                padding: 10px 20px;
                font-size: 1rem;
                font-weight: 600;
                color: #fff;
                background: #4e54c8;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.3s ease;
            }

            #btn-play-again:hover {
                background: #6a11cb;
            }

            #language-select {
                position: absolute;
                top: 20px;
                right: 20px;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 1rem;
            }

            #fireworksCanvas {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                pointer-events: none;
                z-index: 1;
            }

            /* Mobile responsiveness */
            /* @media (max-width: 768px) { */
            span {
                margin: 15px 0 8px !important;
            }
            /* } */

            label {
                margin: 15px 0 8px !important;
            }

            /* Landscape Mode */
            @media screen and (orientation: landscape) {
                @media (max-height: 600px) {
                    body{
                        height: auto;
                        padding: 12px 25px;
                    }
                    .scorecard-container{
                        padding: 1rem 3rem;
                    }
                    #btn-winner{
                        margin-top: -20px;
                        font-weight: 500;
                        left: 85%;
                        height: 30px;
                        width: 25%;
                    }
                    .score-item {
                        padding: 2px 0;
                    }
                    #btn-play-again{
                        left: 70%;
                        margin-top: -40px;
                    }
                    #btn-home{
                        left: 30%;
                        margin-top: 1rem;
                    }

                    #share_button{
                        margin-top: -30px !important;
                        font-weight: 500;
                        left: 98%;
                        height: 30px;
                        width: 30px;
                        margin-left: 25px;
                        border: none;
                    }

                    #share-popup{
                        justify-content: flex-end !important;
                        position: absolute !important;
                        left: 70% !important;
                        top: 1% !important;
                        gap: 0.5rem !important;
                    }
                    
                    #popup_buttons {
                        width: 35px !important;
                        left: 18px !important;
                        margin-top: 0px !important;
                        padding: 0px !important;
                        height: 30px !important;
                    }
                    .scorecard{
                        background-size: 30% 100% !important;
                    }
                }
            }

            @media (max-width: 350px) {
                #play-time{
                    width: 80px !important;
                }
            }

            #popup_buttons{
                width: 30px;
                margin-top: 5px;
                padding: 5px;
            }

            #share-popup{
                justify-content: center;
            }

            #share_button{
                margin-top: 10px;
                height: 35px;
                padding: 5px;
                border: none;
            }

            .custom-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #ccc;
            border-top: 2px solid #333;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: auto;
            display: none;
            }


            @keyframes spin {
            to { transform: rotate(360deg); }
            }

            .scorecard{
                background: url('./../img/trophy.png') no-repeat center;
                background-size: 40% 55%;
            }

            #label-question-type {
                display: inline-block;
                max-width: 100px; /* or any small width */
                white-space: normal;
                word-break: break-word;
            }
            #label-play-time {
                display: inline-block;
                max-width: 100px; /* or any small width */
                white-space: normal;
                word-break: break-word;
            }

        </style>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
        

    </head>
    <body>
        <!-- Fireworks Canvas -->
        <canvas id="fireworksCanvas"></canvas>


        <div class="scorecard-container">
          
            
            <div id="header">Scorecard</div>
            <button id="btn-winner" onclick="showWinners()">
                <i class="fa-solid fa-trophy"></i> Top Scorers
            </button>

            <button id="share_button" onclick="shareImage()" class="btn-light">
                <i class="bi bi-share-fill" id="id_share_icon"></i>
                <div class="custom-spinner" id="spinner_id"></div>
            </button>

            

            <!-- <div id="share-popup" style="display: none; gap: 1rem;">
                <button id="popup_buttons" onclick="shareImage('whatsapp')" class="btn btn-success btn-sm"><i class="bi bi-whatsapp"></i></button>
                <button id="popup_buttons" onclick="shareImage('facebook')" class="btn btn-primary btn-sm"><i class="bi bi-facebook"></i></button>
                <button id="popup_buttons" onclick="shareImage('instagram')" class="btn btn-danger btn-sm"><i class="bi bi-instagram"></i></button>
            </div> -->
              
            <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


            <script>
                function toggleSharePopup() {
                  const popup = document.getElementById("share-popup");
                  popup.style.display = popup.style.display === "none" ? "flex" : "none";
                }
                
                async function shareImage() {
                        const scorecard = document.querySelector(".scorecard-container");
                        const timeTaken= "<%= time %>"

                        // Hide extra UI elements for a clean screenshot
                        document.getElementById("id_share_icon").style.display = "none";
                        document.getElementById("btn-home").style.display = "none";
                        document.getElementById("btn-play-again").style.display = "none";
                        document.getElementById("spinner_id").style.display = "block";

                        try {
                            // Capture the scorecard as canvas
                            const canvas = await html2canvas(scorecard, {
                            scale: window.devicePixelRatio * 2,
                            useCORS: true,
                            backgroundColor: null,
                            allowTaint: true,
                            removeContainer: true
                            });

                            // Convert to Base64 image (data URL)
                            const base64Image = canvas.toDataURL("image/png");

                            // Create your custom share message
                            const shareMessage = `Yey, I played KBDS and finished the game in ${timeTaken} seconds! It's amazing. You should also try this Amazing Jain Game.\n\nDownload from Play Store:`;

                            // Prepare the payload
                            const payload = {
                            type: "share",
                            message: shareMessage,
                            image: base64Image
                            };

                            // ✅ Send the message to Ionic app
                            if (window.cordova_iab && window.cordova_iab.postMessage) {
                            window.cordova_iab.postMessage(JSON.stringify(payload));
                            console.log("Message sent to Ionic app:", payload);
                            } else {
                            console.warn("cordova_iab not available — probably running in browser, not InAppBrowser.");
                            alert("Sharing only works inside the KBDS app.");
                            }
                        } catch (err) {
                            console.error("Error capturing or sharing:", err);
                        } finally {
                            // Restore UI elements
                            document.getElementById("spinner_id").style.display = "none";
                            document.getElementById("btn-home").style.display = "block";
                            document.getElementById("btn-play-again").style.display = "block";
                            document.getElementById("id_share_icon").style.display = "block";
                        }
                        }



            </script>
                


            <div class="scorecard">
                <div class="score-item">
                    <label id="label-username">Player:</label>
                    <span id="username" style="margin: 20px 0 8px;"><%= username %></span>
                </div>

                <div class="score-item">
                    <label id="label-question-type">Level Played:</label>
                    <span id="question-type"><%= questionType %></span>
                </div>

                <div class="score-item">
                    <label id="label-play-time">Play Time:</label>
                    <span id="play-time" style="margin-left: 20px;"><%= time %></span>
                </div>

                <div class="score-item">
                    <label id="label-play-level">Question Cleared:</label>
                    <span id="play-level"><%= level %></span>
                </div>
            </div>

            <button id="btn-home" onclick="goHome()">Back to Home</button>
            <button id="btn-play-again" onclick="playAgain()">Play Again</button>
            <button id="btn-play-again"  onclick="playAgain()">Donate</button>


            <p class="bottom-tag-line">Directed by Vikas Jain</p>
            
            
            <!-- Winner Popup Modal -->
            <div id="winner-modal" style="display: none;" class="modal">
                <style>
                    .top-buttons {
                        display: flex;
                        justify-content: center;
                        gap: 10px;
                        padding: 10px 10px;
                        flex-wrap: wrap;
                    }

                    .top-buttons button {
                        padding: 10px 20px;
                        border: 2px solid orange;
                        border-radius: 25px;
                        background-color: transparent;
                        color: orange;
                        font-weight: bold;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        position: relative;
                        left: 0%;
                        transform: none;
                        height: 40px;
                        width: 20%;
                        font-size: 14px !important;
                        padding: 0px !important;
                        margin: 5px;
                    }

                    @media (max-width: 650px) {
                        .top-buttons {
                            display: block;
                        }
                        .top-buttons button {
                            width: 100%;
                            margin: 20px 0px;
                        }
                        .modal-content{
                            height: 100vh;
                        }
                        .stats {
                            margin-top: 20px;
                        }
                        .footer-time {
                            margin-top: 20px;
                        }
                    }

                    .top-buttons button.active {
                        background-color: orange;
                        color: #3d2b1f; /* dark text like your image */
                        border: none;
                    }

                    .container {
                    padding: 20px;
                    }

                    .score-title {
                    font-size: 20px;
                    }

                    .username {
                    font-size: 24px;
                    font-weight: bold;
                    color: white;
                    margin-top: 10px;
                    }

                    .stats {
                    display: flex;
                    justify-content: space-around;
                    
                    flex-wrap: wrap;
                    }

                    .stat-box {
                    color: orange;
                    margin: 10px;
                    font-size: 24px;
                    }

                    .stat-box span {
                    display: block;
                    font-size: 22px;
                    color: white;
                    margin-top: 10px;
                    }

                    .footer-time {
                    color: orange;
                    font-size: 24px;
                    }
                    
                    #user_rank{
                        color: orange;
                        font-size: 24px;
                    }

                    .footer-time span {
                    display: block;
                    color: white;
                    font-size: 22px;
                    margin-top: 10px;
                    }

                    .section {
                    display: none;
                    padding: 0px;
                    }

                    .section.active {
                    display: block;
                    }

                    span {
                        padding-top: 0px;
                    }
                </style>
                <div class="modal-content">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <!-- <h2>🏆 Top Scorers</h2> -->

                    <div class="top-buttons">
                        <button class="tab-btn active" onclick="showSection('myScores', this)">My Scores</button>
                        <button class="tab-btn" onclick="showSection('questionsPlayed', this)">Questions Played</button>
                        <button class="tab-btn" onclick="showSection('gamesPlayed', this)">Games Played</button>
                        <button class="tab-btn" onclick="showSection('timePlayed', this)">Time Played</button>
                    </div>

                    <script>
                        function showSection(id, btn) {
                          // Hide all sections
                          document.querySelectorAll('.section').forEach(section => {
                            section.classList.remove('active');
                          });
                    
                          // Remove active class from all buttons
                          document.querySelectorAll('.tab-btn').forEach(button => {
                            button.classList.remove('active');
                          });
                    
                          // Show selected section and highlight button
                          document.getElementById(id).classList.add('active');
                          btn.classList.add('active');
                        }
                    </script>
                    
                    <!-- Sections -->
                    <div id="myScores" class="section active">
                        <div class="container">
                            <div class="score-title">Your Score for <%= questionType %> Game</div>
                            <div class="username"><%= username %></div>
                        
                            <div class="stats">
                              <div class="stat-box">
                                Total Games
                                <span><%= game_score %></span>
                              </div>
                              <div class="stat-box">
                                Total Questions
                                <span><%= question_score %></span>
                              </div>
                            </div>
                        
                            <div class="footer-time">
                              Total Time
                              <span>

                                <% 
                                  let formattedTimeScore = time_score;
                                  if (time_score) {
                                    const timeParts = time_score.split(':'); // [00h, 01m, 24s]
                                    formattedTimeScore = 
                                      (timeParts[0] !== '00h' ? timeParts[0] + ':' : '') +
                                      (timeParts[1] !== '00m' ? timeParts[1] + ':' : '') +
                                      timeParts[2];
                                  }
                                %>
                                <%= formattedTimeScore || '-' %>

                              </span>
                
                       
                              
                            </div>
                        </div>
                    </div>

                    <div id="questionsPlayed" class="section">
                        <p id="user_rank" style="margin: 5px 0px;">Your Rank is : <%= userQuestionRank %></p>

                        <table id="winner-table">
                            <thead>
                                <tr>
                                    <th>🏅 Rank</th>
                                    <th><i class="fa-solid fa-user"></i> Username</th>
                                    <th>🚀 Score</th>
                                </tr>
                            </thead>
                            <tbody id="winner-list">
                                <% if (question_played.length > 0) { %>
                                    <% question_played.slice(0, 50).forEach((scorer, index) => { %>
                                        <tr>
                                            <td>#<%= scorer.rank %></td>
                                            <td><i class="fa-solid fa-user"></i> <%= scorer.username %></td>
                                            <td><%= scorer.question_score %></td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4">No top scorers yet</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>

                    </div>

                    <div id="gamesPlayed" class="section">
                        <p id="user_rank" style="margin: 5px 0px;">Your Rank is : <%= userGameRank %></p>

                        <table id="winner-table">
                            <thead>
                                <tr>
                                    <th>🏅 Rank</th>
                                    <th><i class="fa-solid fa-user"></i> Username</th>
                                    <th>🚀 Game</th>
                                </tr>
                            </thead>
                            <tbody id="winner-list">
                                <% if (game_played.length > 0) { %>
                                    <% game_played.slice(0, 50).forEach((scorer, index) => { %>
                                        <tr>
                                            <td>#<%= scorer.rank %></td>
                                            <td><i class="fa-solid fa-user"></i> <%= scorer.username %></td>
                                            <td><%= scorer.game_played %></td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4">No top scorers yet</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                    <div id="timePlayed" class="section">
                        <p id="user_rank" style="margin: 5px 0px;">Your Rank is : <%= userTimeRank %></p>

                        <table id="winner-table">
                            <thead>
                                <tr>
                                    <th>🏅 Rank</th>
                                    <th><i class="fa-solid fa-user"></i> Username</th>
                                    <th>⏱️ Play Time</th>
                                </tr>
                            </thead>
                            <tbody id="winner-list">
                                <% if (time_played.length > 0) { %>
                                    <% time_played.slice(0, 50).forEach((scorer, index) => { %>
                                        <tr>
                                            <td>#<%= scorer.rank %></td>
                                            <td><i class="fa-solid fa-user"></i> <%= scorer.username %></td>
                                           
                                            <td>
                                                <% 
                                                  let formattedTime = scorer.total_play_time;
                                                  if (scorer.total_play_time) {
                                                    const timeParts = scorer.total_play_time.split(':'); // [00h, 01m, 24s]
                                                    formattedTime = 
                                                      (timeParts[0] !== '00h' ? timeParts[0] + ':' : '') +
                                                      (timeParts[1] !== '00m' ? timeParts[1] + ':' : '') +
                                                      timeParts[2];
                                                  }
                                                %>
                                                <%= formattedTime || '-' %>
                                            </td>
                                              
                                            
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="4">No top scorers yet</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div id="score_overlay" style="display: none;"></div>

        </div>


        <script>
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }
            const selected_level = getQueryParam('selected_level') || ''; 
            const user_type = getQueryParam('user_type') || ''; 

            function goHome() {
                    let user = localStorage.getItem("last_user") ;
                    if(user){
                    user = JSON.parse(user);
                    window.location.href = `${window.location.origin}/?id=${user?.id}&username=${user?.username}`;
                    }else{
                        window.location.href ='/'
                    }

            }

            function playAgain() {
                let question_type = document.getElementById('question-type').innerText ;
                // let timestamp = Date.now(); // Current timestamp in ms
                window.location.href = `/play?q_type=${question_type}&level=${selected_level}&user_type=${user_type}&action=playagain`;
            }

            // Fireworks Animation
            const canvas = document.getElementById('fireworksCanvas');
            const ctx = canvas.getContext('2d');

            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            const particles = [];

            function createFirework(x, y) {
                for (let i = 0; i < 80; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        speedX: Math.random() * 4 - 2,
                        speedY: Math.random() * 4 - 2,
                        color: `hsl(${Math.random() * 360}, 100%, 60%)`,
                        life: 100
                    });
                }
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear without affecting background

                for (let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    p.x += p.speedX;
                    p.y += p.speedY;
                    p.life--;

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();

                    if (p.life <= 0) {
                        particles.splice(i, 1);
                    }
                }

                requestAnimationFrame(animate);
            }

            // Create fireworks at intervals
            setInterval(() => {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height * 0.5;
                createFirework(x, y);
            }, 700);

            animate();
            

            function showWinners() {
                document.getElementById("winner-modal").style.display = "block";
                document.getElementById("score_overlay").style.display = "block";
            }

            function closeModal() {
                document.getElementById("winner-modal").style.display = "none";
                document.getElementById("score_overlay").style.display = "none";
            }

            document.getElementById("score_overlay").addEventListener('click',()=>{
                closeModal();
            });

        
        </script>

        <!-- <script>
            // Now push the real page back into history
            history.pushState({}, '', location.href);

            window.addEventListener('popstate', function () {
                // Clear local storage
                localStorage.clear();

                // Clear session storage
                sessionStorage.clear();
                window.location.href = '/'; // Redirect to home page on back
            });
        </script> -->


  
  
  

        <style>
    
            /* Winner Button */
            #btn-winner {
                background: #d14d00;
                color: white;
                border: none;
                padding: 8px 15px;
                font-size: 1rem;
                font-weight: 600;
                border-radius: 8px;
                cursor: pointer;
                transition: 0.3s;
            }

            #btn-winner:hover {
                background: #b34201;
            }

            #score_overlay{
                position: fixed;
                z-index: 9;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 10;
                left: 0;
                top: 0;
                width: 100%;
                height: 100vh;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                overflow: scroll;
            }

            .modal-content {
                background: #222;
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                color: white;
                min-width: 350px;
                box-shadow: 0px 0px 10px white;
                position: relative;
                overflow: scroll;
            }

            .modal-content h2 {
                margin-top: 0;
            }

            .close {
                position: absolute;
                top: 10px;
                right: 15px;
                font-size: 30px;
                cursor: pointer;
                color: white;
            }

            /* Table Styling */
            #winner-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 10px;
                font-size: 0.8rem;
            }

            #winner-table th, #winner-table td {
                border: 1px solid rgba(255, 255, 255, 0.3);
                padding: 10px;
                text-align: center;
            }

            #winner-table th {
                background: #333;
                color: gold;
            }

            #winner-table tr:nth-child(even) {
                background: rgba(255, 255, 255, 0.1);
            }

            #winner-table tr:hover {
                background: rgba(255, 255, 255, 0.2);
            }
        </style>
    </body>
</html>
